<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Forr√°smegjel√∂l√©s ‚Äì 5‚Äì6. √©vfolyam ‚Äì gyakorl√≥ teszt</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; line-height: 1.35; }
    body { margin: 0; background: #f6f7fb; color: #111; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 16px; }
    .card { background: white; border-radius: 14px; padding: 16px; box-shadow: 0 6px 18px rgba(0,0,0,.06); margin-bottom: 12px; }
    h1 { font-size: 20px; margin: 0 0 8px; }
    h2 { font-size: 16px; margin: 0 0 8px; }
    .muted { color: #555; font-size: 13px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    input[type="text"], input[type="password"], textarea {
      width: 100%; padding: 10px 12px; border: 1px solid #d6d8e1; border-radius: 10px; font-size: 14px; box-sizing: border-box;
      background: #fff;
    }
    textarea { min-height: 62px; resize: vertical; }
    button {
      border: 0; border-radius: 10px; padding: 10px 12px; font-size: 14px; cursor: pointer;
      background: #1f6feb; color: #fff;
    }
    button.secondary { background: #2f3542; }
    button.ghost { background: #e9ecf6; color: #111; }
    button.danger { background: #d7263d; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .q { padding: 12px; border: 1px solid #eceef6; border-radius: 12px; margin-top: 10px; }
    .q-title { font-weight: 700; margin: 0 0 8px; }
    .opt { display: block; padding: 8px 10px; border: 1px solid #eceef6; border-radius: 10px; margin: 6px 0; background: #fafbff; }
    .opt input { margin-right: 8px; }
    .badge { display:inline-block; padding: 4px 8px; border-radius: 999px; background:#eef3ff; font-size: 12px; }
    .ok { color: #0a7a2f; font-weight: 700; }
    .err { color: #b00020; font-weight: 700; }
    .hr { height: 1px; background: #eceef6; margin: 10px 0; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eceef6; padding: 8px; text-align: left; font-size: 13px; vertical-align: top; }
    th { background: #fafbff; position: sticky; top: 0; z-index: 1; }
    .small { font-size: 12px; }
    .hidden { display:none !important; }
    .right { margin-left: auto; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <div>
          <h1>Forr√°smegjel√∂l√©s ‚Äì 5‚Äì6. √©vfolyam ‚Äì gyakorl√≥ teszt</h1>
          <div class="muted">N√©v ‚Üí kit√∂lt√©s ‚Üí pontsz√°m ‚Üí ment√©s Firestore-ba ‚Üí tan√°ri n√©zet (indokl√°sok + CSV).</div>
        </div>
        <div class="right row">
          <button id="btnTeacher" class="secondary" type="button">Tan√°ri n√©zet</button>
          <button id="btnResetLocal" class="ghost" type="button" title="Ha elrontott√°k a nevet vagy √∫jra akarj√°k kezdeni ugyanazon a g√©pen.">Helyi √∫jrakezd√©s</button>
        </div>
      </div>
      <div class="hr"></div>
      <div id="status" class="muted">√Ållapot: bet√∂lt√©s‚Ä¶</div>
    </div>

    <div id="studentStart" class="card">
      <h2>1) Add meg a neved</h2>
      <div class="muted">Pl. ‚ÄûBence 6.a‚Äù.</div>
      <div class="row" style="margin-top:10px;">
        <div style="flex: 1 1 280px;">
          <input id="studentName" type="text" placeholder="N√©v" autocomplete="off" />
        </div>
        <div>
          <button id="btnStart" type="button">Kezd√©s</button>
        </div>
      </div>
      <div id="nameError" class="err small hidden" style="margin-top:8px;">K√©rlek, √≠rj be nevet (legal√°bb 2 karakter).</div>
    </div>

    <div id="quiz" class="card hidden">
      <div class="row">
        <div class="badge" id="progressBadge">0 / 0</div>
        <div class="muted" id="quizHint">Olvasd v√©gig mind a 4 v√°laszt, t√∂bb k√©rd√©sn√©l ‚Äûcsapda‚Äù van a pontoss√°g miatt.</div>
      </div>

      <div id="questions"></div>

      <div class="hr"></div>
      <div class="row">
        <button id="btnSubmit" type="button">Bek√ºld√©s √©s eredm√©ny</button>
        <div class="muted" id="submitInfo">Bek√ºld√©skor a v√°laszok ment√©sre ker√ºlnek.</div>
      </div>
      <div id="submitError" class="err small hidden" style="margin-top:8px;"></div>
    </div>

    <div id="result" class="card hidden">
      <h2>Eredm√©ny</h2>
      <div id="resultSummary" class="muted"></div>
      <div class="hr"></div>
      <div id="resultFeedback"></div>
      <div class="hr"></div>
      <div class="muted small">
        Megjegyz√©s: az indokl√°sok sz√∂veg√©t a tan√°r a tan√°ri n√©zetben l√°tja √©s ellen≈ërizheti.
      </div>
    </div>

    <div id="teacher" class="card hidden">
      <h2>Tan√°ri n√©zet</h2>
      <div class="muted">Jelsz√≥val nyithat√≥ (UI-v√©delem). Itt l√°tod a bek√ºld√©seket √©s az indokl√°sokat.</div>
      <div class="row" style="margin-top:10px;">
        <div style="flex: 1 1 240px;">
          <input id="teacherPass" type="password" placeholder="Tan√°ri jelsz√≥" autocomplete="off" />
        </div>
        <div class="row">
          <button id="btnTeacherLogin" type="button">Bel√©p√©s</button>
          <button id="btnTeacherClose" class="ghost" type="button">Bez√°r</button>
        </div>
      </div>
      <div id="teacherAuthError" class="err small hidden" style="margin-top:8px;">Hib√°s jelsz√≥.</div>

      <div id="teacherPanel" class="hidden" style="margin-top:14px;">
        <div class="row">
          <div class="muted"><span class="badge" id="countBadge">0</span> bek√ºld√©s</div>
          <div class="right row">
            <button id="btnRefresh" class="ghost" type="button">Friss√≠t√©s</button>
            <button id="btnExport" class="secondary" type="button">CSV export</button>
            <button id="btnDeleteAll" class="danger" type="button">√ñsszes t√∂rl√©se</button>
          </div>
        </div>
        <div class="hr"></div>
        <div style="max-height: 520px; overflow:auto; border:1px solid #eceef6; border-radius: 12px;">
          <table id="submissionsTable">
            <thead>
              <tr>
                <th>Id≈ë</th>
                <th>N√©v</th>
                <th>Pont</th>
                <th>MCQ</th>
                <th>Igen/Nem + indokl√°s</th>
                <th>M≈±velet</th>
              </tr>
            </thead>
            <tbody id="submissionsBody"></tbody>
          </table>
        </div>
        <div class="muted small" style="margin-top:8px;">Tipp: alapb√≥l az utols√≥ 200 bek√ºld√©st t√∂lti be.</div>
      </div>
    </div>
  </div>

  <script type="module">
    /*********************************************************************
     * 0) BE√ÅLL√çT√ÅSOK
     *********************************************************************/
    const TEACHER_PASSWORD = "Nixi99Nixi99";

    // ‚úÖ UGYANAZ a Firebase projekt, mint a 4.-esn√©l -> ide a TE kulcsod/appId-d:
    const firebaseConfig = {
      apiKey: "AIzaSyC2ZN37vvWua8SY4h5dj0mZapcRIKeAAGo",
      authDomain: "forras-gyakorlo.firebaseapp.com",
      projectId: "forras-gyakorlo",
      storageBucket: "forras-gyakorlo.firebasestorage.app",
      messagingSenderId: "71098032558",
      appId: "1:71098032558:web:44e7cef8c5c9900ac2a83f"
    };

    // ‚úÖ √öJ collection n√©v az 5‚Äì6-osoknak (ett≈ël lesz k√ºl√∂n adatgy≈±jt√©s)
    const COLLECTION = "forras_56_submissions";

    /*********************************************************************
     * 1) FIREBASE IMPORTS
     *********************************************************************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp, query, orderBy, limit,
      getDocs, deleteDoc, doc
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    /*********************************************************************
     * 2) DOM helpers
     *********************************************************************/
    const $ = (id) => document.getElementById(id);
    const show = (el) => el.classList.remove("hidden");
    const hide = (el) => el.classList.add("hidden");
    const setText = (el, t) => (el.textContent = t);

    /*********************************************************************
     * 3) K√âRD√âSEK (5‚Äì6. √©vfolyam)
     *********************************************************************/
    const mcq = [
      { id:"mcq1", q:"Melyik √°ll√≠t√°s a legpontosabb a forr√°smegjel√∂l√©s c√©lj√°r√≥l?",
        options:[
          "Az√©rt kell, hogy hosszabb legyen a dolgozat.",
          "Az√©rt kell, hogy a tan√°r ne tudjon belek√∂tni.",
          "Az√©rt kell, hogy ellen≈ërizhet≈ë legyen, honnan sz√°rmazik az inform√°ci√≥, √©s korrekt legyen a munka.",
          "Az√©rt kell, mert minden weboldal k√∂telez≈ëen k√©ri."
        ],
        correctIndex:2,
        explain:"A forr√°smegjel√∂l√©s √°tl√°that√≥v√° √©s ellen≈ërizhet≈ëv√© teszi, honnan van az info."
      },
      { id:"mcq2", q:"Melyik NEM sz√°m√≠t √∂nmag√°ban el√©g pontos webes forr√°snak?",
        options:[
          "A konkr√©t oldal c√≠me + link + (ha lehet) d√°tum",
          "‚ÄûGoogle‚Äù",
          "A weboldal neve + konkr√©t aloldal linkje",
          "A cikk c√≠me + link"
        ],
        correctIndex:1,
        explain:"A Google keres≈ë, nem konkr√©t forr√°s."
      },
      { id:"mcq3", q:"Egy Wikip√©di√°s inform√°ci√≥t haszn√°lt√°l. Mi a legkorrektebb megold√°s?",
        options:[
          "Nem kell jel√∂lni, mert Wikipedia = k√∂z√∂s tud√°s.",
          "El√©g annyi: ‚ÄûForr√°s: Wikip√©dia‚Äù.",
          "A pontos Wikip√©dia-oldal c√≠me + link (√©s ha lehet: megtekint√©s d√°tuma).",
          "A Wikip√©dia log√≥j√°t bem√°solod a dolgozatba."
        ],
        correctIndex:2,
        explain:"Wikip√©di√°n√°l is a konkr√©t oldal a forr√°s."
      },
      { id:"mcq4", q:"Mit≈ël lesz pl√°giumgyan√∫s egy beadand√≥?",
        options:[
          "Ha t√∫l r√∂vid.",
          "Ha sok benne a k√©p.",
          "Ha id√©z≈ëjel n√©lk√ºl, forr√°s n√©lk√ºl vesz √°t sz√≥ szerinti r√©szeket.",
          "Ha helyes√≠r√°si hib√°k vannak benne."
        ],
        correctIndex:2,
        explain:"A sz√≥ szerinti √°tv√©tel jel√∂l√©s n√©lk√ºl pl√°giumgyan√∫s."
      },
      { id:"mcq5", q:"Melyik a j√≥ elv, ha ugyanarr√≥l t√∂bb forr√°sban is olvast√°l?",
        options:[
          "Azt jel√∂l√∂m, amit t√©nyleg haszn√°ltam, √©s lehet≈ëleg a megb√≠zhat√≥bbat.",
          "Nem jel√∂l√∂k semmit, mert t√∂bb helyen is megtal√°lhat√≥.",
          "B√°rmelyiket jel√∂l√∂m, ak√°r olyat is, amit nem olvastam.",
          "Csak a legr√∂videbbet jel√∂l√∂m, mert az a legegyszer≈±bb."
        ],
        correctIndex:0,
        explain:"A t√©nylegesen haszn√°lt forr√°st kell jel√∂lni."
      },
      { id:"mcq6", q:"Melyik mondat √≠rja le legjobban a ‚Äûparafr√°zist‚Äù?",
        options:[
          "Kim√°solom a sz√∂veget, de kicser√©lek 1‚Äì2 sz√≥t.",
          "Elolvasom, meg√©rtem, √©s a saj√°t szavaimmal, √∫j mondatszerkezettel fogalmazom meg.",
          "Csak a mondat elej√©t √≠rom √°t, a t√∂bbi marad.",
          "Lemondom a forr√°smegjel√∂l√©st, mert saj√°t szavakkal √≠rtam."
        ],
        correctIndex:1,
        explain:"Saj√°t megfogalmaz√°s, de a forr√°st ett≈ël m√©g jel√∂lheted."
      },
      { id:"mcq7", q:"K√©pet haszn√°lsz egy weboldalr√≥l. Mi a minimum korrekt jel√∂l√©s?",
        options:[
          "Semmi, mert a k√©p ‚Äûcsak illusztr√°ci√≥‚Äù.",
          "Az oldal neve (vagy k√©p c√≠me) + a link, ahonnan a k√©pet vetted.",
          "A f√°jln√©v (pl. IMG_1234.jpg).",
          "Annyi: ‚Äûforr√°s: internet‚Äù."
        ],
        correctIndex:1,
        explain:"K√©pn√©l is kell a konkr√©t lel≈ëhely."
      },
      { id:"mcq8", q:"YouTube-vide√≥b√≥l vett√©l inform√°ci√≥t. Mi a legjobb forr√°smegjel√∂l√©s?",
        options:[
          "‚ÄûForr√°s: YouTube‚Äù",
          "Csak a csatorna neve",
          "A vide√≥ c√≠me + csatorna neve + link (√©s ha lehet: megtekint√©s d√°tuma)",
          "A vide√≥ alatti komment"
        ],
        correctIndex:2,
        explain:"Vide√≥n√°l is a konkr√©t vide√≥ a forr√°s."
      },
      { id:"mcq9", q:"Melyik √°ll√≠t√°s igaz az id√©z√©sr≈ël?",
        options:[
          "Id√©zni csak k√∂nyvb≈ël lehet.",
          "Ha id√©z≈ëjelbe teszem √©s megadom a forr√°st, akkor korrekt id√©zetet k√©sz√≠tek.",
          "Id√©z≈ëjel n√©lk√ºl is id√©zet, ha oda√≠rom a szerz≈ë nev√©t.",
          "Id√©zetn√©l nem kell forr√°s, mert √∫gyis l√°tszik, hogy m√°s√©."
        ],
        correctIndex:1,
        explain:"Id√©z≈ëjel + forr√°s = korrekt id√©z√©s."
      },
      { id:"mcq10", q:"Mi√©rt probl√©m√°s az, hogy ‚Äûforr√°s: internet‚Äù?",
        options:[
          "Mert az internet nem l√©tezik.",
          "Mert t√∫l hossz√∫.",
          "Mert nem der√ºl ki bel≈ële, pontosan melyik oldal/cikk volt a forr√°s.",
          "Mert a tan√°r nem szereti ezt a kifejez√©st."
        ],
        correctIndex:2,
        explain:"Nem visszakereshet≈ë, nem ellen≈ërizhet≈ë."
      },
      { id:"mcq11", q:"Mi a legkorrektebb, ha AI-t (pl. ChatGPT-t) haszn√°lt√°l √∂tletel√©sre vagy jav√≠t√°sra?",
        options:[
          "Eltitkolom, mert AI-t haszn√°lni tilos.",
          "Nem jel√∂l√∂m, mert nem ‚Äûforr√°s‚Äù, csak seg√≠tett.",
          "A dolgozat v√©g√©n r√∂viden jelzem, mire haszn√°ltam (pl. √∂tletel√©s, nyelvi jav√≠t√°s).",
          "Csak a program nev√©t √≠rom le, minden magyar√°zat n√©lk√ºl."
        ],
        correctIndex:2,
        explain:"Az √°tl√°that√≥s√°g a l√©nyeg: mire haszn√°ltad."
      },
      { id:"mcq12", q:"Melyik forr√°s t≈±nik √°ltal√°ban megb√≠zhat√≥bbnak iskolai munk√°hoz?",
        options:[
          "Egy n√©vtelen f√≥rumhozz√°sz√≥l√°s",
          "Egy ismeretlen TikTok vide√≥",
          "Egy tank√∂nyv / m√∫zeum / egyetem / hivatalos int√©zm√©ny oldala",
          "Egy komment egy vide√≥ alatt"
        ],
        correctIndex:2,
        explain:"√Åltal√°ban a szakmai/oktat√°si/hivatalos forr√°s megb√≠zhat√≥bb."
      }
    ];

    const yn = [
      { id:"yn1", q:"Helyes-e: ‚ÄûForr√°s: Wikip√©dia‚Äù (csak ennyi van oda√≠rva).", correctYes:false, why:"T√∫l √°ltal√°nos: a pontos oldal c√≠me + link sz√ºks√©ges." },
      { id:"yn2", q:"Helyes-e: Id√©z≈ëjelbe teszek egy mondatot, √©s mell√© √≠rom a cikk c√≠m√©t + linket.", correctYes:true,  why:"Id√©zetn√©l fontos a jel√∂l√©s, ez √≠gy korrekt." },
      { id:"yn3", q:"Helyes-e: Parafr√°zist √≠rok saj√°t szavakkal, ez√©rt nem √≠rok forr√°st.", correctYes:false, why:"Saj√°t megfogalmaz√°s mellett is jel√∂lhet≈ë/aj√°nlott a forr√°s." },
      { id:"yn4", q:"Helyes-e: K√©pet haszn√°lok, √©s a k√©p al√°√≠r√°s√°ban megadom a forr√°s linkj√©t.", correctYes:true,  why:"K√©pn√©l is korrekt a lel≈ëhely megad√°sa." },
      { id:"yn5", q:"Helyes-e: A bar√°tom PPT-j√©b≈ël √°tm√°solok egy √°br√°t, √©s nem jelzem, mert ≈ë is di√°k.", correctYes:false, why:"M√°s munk√°ja is forr√°s; jel√∂l√©s n√©lk√ºl nem korrekt." },
      { id:"yn6", q:"Helyes-e: A forr√°slist√°ban szerepel a cikk c√≠me, a weboldal neve, a link, √©s a megtekint√©s d√°tuma.", correctYes:true,  why:"Visszakereshet≈ë √©s pontos, ez j√≥ gyakorlat." }
    ];

    const totalAutoPoints = mcq.length + yn.length;

    /*********************************************************************
     * 4) APP STATE
     *********************************************************************/
    let db = null;
    let student = { name:"", answers:{}, justifications:{}, score:0, maxScore: totalAutoPoints };

    const safeNowISO = () => new Date().toISOString();
    const escapeHtml = (s) => String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");

    /*********************************************************************
     * 5) RENDER QUESTIONS
     *********************************************************************/
    function renderQuestions() {
      const holder = $("questions");
      holder.innerHTML = "";

      const mcqHeader = document.createElement("div");
      mcqHeader.className = "q";
      mcqHeader.innerHTML = `<div class="q-title">A) Elm√©leti k√©rd√©sek (4 v√°lasz) ‚Äì v√°lassz egyet</div>
                             <div class="muted small">Tipp: olvasd v√©gig mind a 4 opci√≥t.</div>`;
      holder.appendChild(mcqHeader);

      mcq.forEach((item, idx) => {
        const div = document.createElement("div");
        div.className = "q";
        div.innerHTML = `<div class="q-title">${idx+1}. ${item.q}</div>`;
        item.options.forEach((opt, oi) => {
          const lab = document.createElement("label");
          lab.className = "opt";
          lab.innerHTML = `<input type="radio" name="${item.id}" value="${oi}"> ${opt}`;
          div.appendChild(lab);
        });
        holder.appendChild(div);
      });

      const ynHeader = document.createElement("div");
      ynHeader.className = "q";
      ynHeader.innerHTML = `<div class="q-title">B) Igen / Nem + indokl√°s (1 mondat)</div>
                            <div class="muted small">V√°laszd ki, hogy helyes-e, √©s √≠rd le r√∂viden, mi√©rt.</div>`;
      holder.appendChild(ynHeader);

      yn.forEach((item, idx) => {
        const div = document.createElement("div");
        div.className = "q";
        div.innerHTML = `<div class="q-title">${idx+1}. ${item.q}</div>
          <label class="opt"><input type="radio" name="${item.id}" value="yes"> Igen</label>
          <label class="opt"><input type="radio" name="${item.id}" value="no"> Nem</label>
          <div class="muted small" style="margin-top:8px;">Indokl√°s (1 mondat):</div>
          <textarea id="${item.id}_why" placeholder="√çrj 1 mondatot (pl. mert...)."></textarea>`;
        holder.appendChild(div);
      });

      setText($("progressBadge"), `K√©rd√©sek: ${mcq.length} + ${yn.length} = ${totalAutoPoints} pont (automatikus)`);
    }

    function collectAnswers() {
      const answers = {};
      const just = {};

      mcq.forEach((item) => {
        const checked = document.querySelector(`input[name="${item.id}"]:checked`);
        answers[item.id] = checked ? Number(checked.value) : null;
      });

      yn.forEach((item) => {
        const checked = document.querySelector(`input[name="${item.id}"]:checked`);
        answers[item.id] = checked ? checked.value : null;
        just[item.id] = ($(`${item.id}_why`).value || "").trim();
      });

      return { answers, justifications: just };
    }

    function validateBeforeSubmit(payload) {
      for (const item of mcq) {
        if (payload.answers[item.id] === null) return `Hi√°nyzik v√°lasz: "${item.q}"`;
      }
      for (const item of yn) {
        if (payload.answers[item.id] === null) return `Hi√°nyzik Igen/Nem v√°lasz: "${item.q}"`;
        const t = payload.justifications[item.id] || "";
        if (t.length < 10 || !t.includes(" ")) return `K√©rlek, √≠rj 1 mondatos indokl√°st enn√©l: "${item.q}"`;
      }
      return null;
    }

    function computeScore(answers) {
      let s = 0;
      mcq.forEach((item) => { if (answers[item.id] === item.correctIndex) s += 1; });
      yn.forEach((item) => {
        const isYes = answers[item.id] === "yes";
        const correct = (isYes === item.correctYes);
        if (correct) s += 1;
      });
      return s;
    }

    function buildFeedback(payload) {
      const out = document.createElement("div");

      const header = document.createElement("div");
      header.className = "card";
      header.innerHTML = `<h2>R√∂vid visszajelz√©s</h2>
        <div class="muted">A feleletv√°laszt√≥s hib√°kn√°l megmutatom a helyes v√°laszt √©s a r√∂vid indokl√°st.</div>`;
      out.appendChild(header);

      const wrongs = [];
      mcq.forEach((item, i) => {
        const a = payload.answers[item.id];
        if (a !== item.correctIndex) wrongs.push({ item, index:i, a });
      });

      const mcqBlock = document.createElement("div");
      mcqBlock.className = "q";
      mcqBlock.innerHTML = `<div class="q-title">Elm√©leti k√©rd√©sek ‚Äì ellen≈ërz√©s</div>`;
      if (wrongs.length === 0) {
        mcqBlock.innerHTML += `<div class="ok">Minden feleletv√°laszt√≥s k√©rd√©sed j√≥ lett.</div>`;
      } else {
        wrongs.slice(0, 7).forEach(w => {
          const correctText = w.item.options[w.item.correctIndex];
          const yourText = (w.a === null) ? "(nincs v√°lasz)" : w.item.options[w.a];
          const div = document.createElement("div");
          div.style.marginTop = "8px";
          div.innerHTML = `<div><span class="err">Nem j√≥</span> ‚Äì ${w.index+1}. ${w.item.q}</div>
            <div class="small muted">A te v√°laszod: <b>${escapeHtml(yourText)}</b></div>
            <div class="small muted">A helyes: <b>${escapeHtml(correctText)}</b></div>
            <div class="small muted">Mi√©rt: ${escapeHtml(w.item.explain)}</div>`;
          mcqBlock.appendChild(div);
        });
        if (wrongs.length > 7) {
          mcqBlock.innerHTML += `<div class="muted small" style="margin-top:8px;">Tov√°bbi hib√°k is voltak, de nem list√°zom mindet.</div>`;
        }
      }
      out.appendChild(mcqBlock);

      const ynBlock = document.createElement("div");
      ynBlock.className = "q";
      ynBlock.innerHTML = `<div class="q-title">Igen/Nem ‚Äì helyes megold√°sok</div>`;
      yn.forEach((item, i) => {
        const ans = payload.answers[item.id];
        const isYes = ans === "yes";
        const correct = (isYes === item.correctYes);
        const line = document.createElement("div");
        line.style.marginTop = "8px";
        line.innerHTML = `<div><b>${i+1}.</b> ${item.q}</div>
          <div class="small">${correct ? `<span class="ok">J√≥</span>` : `<span class="err">Nem j√≥</span>`}
          ‚Äì magyar√°zat: <span class="muted">${escapeHtml(item.why)}</span></div>`;
        ynBlock.appendChild(line);
      });
      out.appendChild(ynBlock);

      return out;
    }

    /*********************************************************************
     * 6) FIRESTORE
     *********************************************************************/
    function initFirebase() {
      try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        setText($("status"), "√Ållapot: Firebase OK.");
      } catch (e) {
        console.error(e);
        setText($("status"), "√Ållapot: Firebase hiba ‚Äì val√≥sz√≠n≈±leg hib√°s a config vagy a bet√∂lt√©s.");
      }
    }

    async function saveSubmission(payload) {
      if (!db) throw new Error("Nincs Firestore kapcsolat (db=null).");
      const docData = {
        studentName: student.name,
        createdAt: serverTimestamp(),
        createdAtClient: safeNowISO(),
        score: student.score,
        maxScore: student.maxScore,
        answers: payload.answers,
        justifications: payload.justifications,
        version: "forras_56_v1"
      };
      const ref = await addDoc(collection(db, COLLECTION), docData);
      return ref.id;
    }

    /*********************************************************************
     * 7) TEACHER VIEW
     *********************************************************************/
    async function loadSubmissions() {
      if (!db) throw new Error("Nincs Firestore kapcsolat.");
      const qy = query(collection(db, COLLECTION), orderBy("createdAtClient", "desc"), limit(200));
      const snap = await getDocs(qy);
      const rows = [];
      snap.forEach(d => rows.push({ id: d.id, ...d.data() }));
      return rows;
    }

    function formatTime(row) {
      const s = row.createdAtClient || "";
      return s ? s.replace("T"," ").replace("Z","") : "";
    }

    function summarizeMCQ(row) {
      let correct = 0;
      for (const item of mcq) {
        if (row.answers && row.answers[item.id] === item.correctIndex) correct++;
      }
      return `${correct}/${mcq.length}`;
    }

    function summarizeYN(row) {
      let correct = 0;
      const lines = [];
      yn.forEach((item, i) => {
        const a = row.answers ? row.answers[item.id] : null;
        const isYes = a === "yes";
        const ok = (isYes === item.correctYes);
        if (ok) correct++;
        const why = (row.justifications && row.justifications[item.id]) ? row.justifications[item.id] : "";
        lines.push(`${i+1}) ${ok ? "‚úì" : "‚úó"} ‚Äì ${why}`);
      });
      return { correct, text: lines.join("\n") };
    }

    function renderTeacherTable(rows) {
      const body = $("submissionsBody");
      body.innerHTML = "";
      setText($("countBadge"), String(rows.length));

      rows.forEach(row => {
        const tr = document.createElement("tr");
        const ynSum = summarizeYN(row);

        const tdTime = document.createElement("td");
        tdTime.textContent = formatTime(row);

        const tdName = document.createElement("td");
        tdName.textContent = row.studentName || "";

        const tdScore = document.createElement("td");
        tdScore.innerHTML = `<b>${row.score ?? "?"}</b> / ${row.maxScore ?? totalAutoPoints}
          <div class="small muted">YN: ${ynSum.correct}/${yn.length}</div>`;

        const tdMCQ = document.createElement("td");
        tdMCQ.textContent = summarizeMCQ(row);

        const tdYN = document.createElement("td");
        tdYN.innerHTML = `<pre style="white-space:pre-wrap; margin:0; font-family: inherit; font-size:12px;">${escapeHtml(ynSum.text)}</pre>`;

        const tdAct = document.createElement("td");
        const btnDel = document.createElement("button");
        btnDel.className = "danger";
        btnDel.textContent = "T√∂rl√©s";
        btnDel.onclick = async () => {
          if (!confirm(`T√∂rl√∂d ezt a bek√ºld√©st? (${row.studentName || "n√©v n√©lk√ºl"})`)) return;
          await deleteDoc(doc(db, COLLECTION, row.id));
          await refreshTeacher();
        };
        tdAct.appendChild(btnDel);

        tr.appendChild(tdTime);
        tr.appendChild(tdName);
        tr.appendChild(tdScore);
        tr.appendChild(tdMCQ);
        tr.appendChild(tdYN);
        tr.appendChild(tdAct);

        body.appendChild(tr);
      });
    }

    async function refreshTeacher() {
      try {
        const rows = await loadSubmissions();
        renderTeacherTable(rows);
      } catch (e) {
        alert("Hiba a bet√∂lt√©sn√©l: " + (e?.message || String(e)));
      }
    }

    function csvCell(v) {
      const s = String(v ?? "");
      const needs = /[",\n]/.test(s);
      const esc = s.replaceAll('"','""');
      return needs ? `"${esc}"` : esc;
    }

    function exportCSVFromTable() {
      const rows = [];
      const header = ["Id≈ë","N√©v","Pont","MaxPont","MCQ_√∂sszegz√©s","YN_indokl√°sok"];
      rows.push(header);

      const trs = Array.from($("submissionsBody").querySelectorAll("tr"));
      trs.forEach(tr => {
        const tds = Array.from(tr.querySelectorAll("td"));
        const time = tds[0]?.innerText?.trim() ?? "";
        const name = tds[1]?.innerText?.trim() ?? "";
        const scoreLine = tds[2]?.innerText?.trim() ?? "";
        const firstLine = scoreLine.split("\n")[0] || "";
        const m = firstLine.match(/(\d+)\s*\/\s*(\d+)/);
        const score = m ? m[1] : "";
        const max = m ? m[2] : "";
        const mcqSum = tds[3]?.innerText?.trim() ?? "";
        const ynText = tds[4]?.innerText?.trim() ?? "";
        rows.push([time,name,score,max,mcqSum,ynText].map(csvCell));
      });

      const csv = rows.map(r => r.join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "forras_56_eredmenyek.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    /*********************************************************************
     * 8) UI WIRING
     *********************************************************************/
    function resetLocal() {
      localStorage.removeItem("forras56_name");
      localStorage.removeItem("forras56_submitted");
      location.reload();
    }
    function loadNameIfAny() {
      const n = localStorage.getItem("forras56_name");
      if (n) $("studentName").value = n;
    }
    function markSubmitted() { localStorage.setItem("forras56_submitted", "1"); }
    function alreadySubmitted() { return localStorage.getItem("forras56_submitted") === "1"; }

    function startQuiz() {
      const name = ($("studentName").value || "").trim();
      if (name.length < 2) { show($("nameError")); return; }
      hide($("nameError"));
      student.name = name;
      localStorage.setItem("forras56_name", name);

      hide($("studentStart"));
      show($("quiz"));
      renderQuestions();

      if (alreadySubmitted()) {
        $("submitInfo").textContent = "Megjegyz√©s: ezen a g√©pen m√°r volt bek√ºld√©s. Ha √∫jra kell kezdeni, kattints a ‚ÄûHelyi √∫jrakezd√©s‚Äù-re.";
      }
    }

    async function submitQuiz() {
      hide($("submitError"));
      const payload = collectAnswers();
      const err = validateBeforeSubmit(payload);
      if (err) { $("submitError").textContent = err; show($("submitError")); return; }

      student.answers = payload.answers;
      student.justifications = payload.justifications;
      student.score = computeScore(payload.answers);

      $("btnSubmit").disabled = true;
      $("btnSubmit").textContent = "Ment√©s folyamatban‚Ä¶";

      try {
        const id = await saveSubmission(payload);
        markSubmitted();
        hide($("quiz"));
        show($("result"));

        $("resultSummary").innerHTML = `N√©v: <b>${escapeHtml(student.name)}</b><br>
          Automatikus pontsz√°m: <b>${student.score}</b> / ${student.maxScore}<br>
          Ment√©s azonos√≠t√≥: <span class="badge">${escapeHtml(id)}</span>`;

        const fb = buildFeedback(payload);
        $("resultFeedback").innerHTML = "";
        $("resultFeedback").appendChild(fb);

      } catch (e) {
        console.error(e);
        $("submitError").textContent = "Ment√©si hiba. Ellen≈ërizd a Firestore Rules-t √©s a firebaseConfig-ot.";
        show($("submitError"));
      } finally {
        $("btnSubmit").disabled = false;
        $("btnSubmit").textContent = "Bek√ºld√©s √©s eredm√©ny";
      }
    }

    function openTeacher() {
      show($("teacher"));
      $("teacherPass").value = "";
      hide($("teacherAuthError"));
      hide($("teacherPanel"));
    }
    function closeTeacher() { hide($("teacher")); }

    function teacherLogin() {
      const pw = $("teacherPass").value || "";
      if (pw !== TEACHER_PASSWORD) { show($("teacherAuthError")); return; }
      hide($("teacherAuthError"));
      show($("teacherPanel"));
      refreshTeacher();
    }

    async function deleteAllSubmissions() {
      if (!confirm("Biztosan t√∂rl√∂d AZ √ñSSZES bek√ºld√©st? Ez nem visszavonhat√≥.")) return;
      if (!confirm("M√°sodik meger≈ës√≠t√©s: t√©nyleg minden bek√ºld√©st t√∂rl√ºnk?")) return;

      try {
        const rows = await loadSubmissions();
        for (const r of rows) await deleteDoc(doc(db, COLLECTION, r.id));
        await refreshTeacher();
        alert("K√©sz: t√∂r√∂lve.");
      } catch (e) {
        alert("Hiba t√∂rl√©skor: " + (e?.message || String(e)));
      }
    }

    // init
    initFirebase();
    loadNameIfAny();

    $("btnStart").addEventListener("click", startQuiz);
    $("btnSubmit").addEventListener("click", submitQuiz);
    $("btnTeacher").addEventListener("click", openTeacher);
    $("btnTeacherClose").addEventListener("click", closeTeacher);
    $("btnTeacherLogin").addEventListener("click", teacherLogin);
    $("btnRefresh").addEventListener("click", refreshTeacher);
    $("btnExport").addEventListener("click", exportCSVFromTable);
    $("btnDeleteAll").addEventListener("click", deleteAllSubmissions);
    $("btnResetLocal").addEventListener("click", resetLocal);

    $("studentName").addEventListener("keydown", (e) => { if (e.key === "Enter") startQuiz(); });
    $("teacherPass").addEventListener("keydown", (e) => { if (e.key === "Enter") teacherLogin(); });
  </script>
<!-- üî• Firebase CDN -->
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js"></script>

<script>
  // üî• Firebase config ‚Äì A TE PROJEKTED
  const firebaseConfig = {
    apiKey: "AIzaSyClYzdDy4BCB-b2GMDO2lA1fMTbw8SkkY4",
    authDomain: "forras-56.firebaseapp.com",
    projectId: "forras-56",
    storageBucket: "forras-56.firebasestorage.app",
    messagingSenderId: "259665371030",
    appId: "1:259665371030:web:cbdef457d37b4dde3a87b7"
  };

  // üî• Firebase inicializ√°l√°s
  firebase.initializeApp(firebaseConfig);

  // üî• Firestore adatb√°zis
  const db = firebase.firestore();

  // üî• Collection neve (56-os k√ºl√∂n!)
  const COLLECTION = "forras56_submissions";
</script>

</body>
</html>
